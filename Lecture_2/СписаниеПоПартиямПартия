Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура КАК Номенклатура,
	|	СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
	|	РасходнаяНакладнаяСписокНоменклатуры.Партия КАК Партия
	|ПОМЕСТИТЬ ВТ_ТЧ_Товары
	|ИЗ
	|	Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
	|ГДЕ
	|	РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	РасходнаяНакладнаяСписокНоменклатуры.Номенклатура,
	|	РасходнаяНакладнаяСписокНоменклатуры.Партия
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Партия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ТЧ_Товары.Номенклатура КАК Номенклатура,
	|	ВТ_ТЧ_Товары.Номенклатура.Представление КАК НоменклатураПредставление,
	|	ВТ_ТЧ_Товары.Партия КАК Партия,
	|	ВТ_ТЧ_Товары.Партия.Представление КАК ПартияПредставление,
	|	ЕСТЬNULL(ОстаткиНоменклатурыОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
	|	ЕСТЬNULL(ОстаткиНоменклатурыОстатки.СтоимостьОстаток, 0) КАК СтоимостьОстаток,
	|	&Период КАК Период
	|ИЗ
	|	ВТ_ТЧ_Товары КАК ВТ_ТЧ_Товары
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры.Остатки(
	|				&МоментВремени,
	|				(Номенклатура, Партия) В
	|					(ВЫБРАТЬ
	|						ВТ_ТЧ_Товары.Номенклатура КАК Номенклатура,
	|						ВТ_ТЧ_Товары.Партия КАК Партия
	|					ИЗ
	|						ВТ_ТЧ_Товары КАК ВТ_ТЧ_Товары)) КАК ОстаткиНоменклатурыОстатки
	|		ПО ВТ_ТЧ_Товары.Номенклатура = ОстаткиНоменклатурыОстатки.Номенклатура
	|			И ВТ_ТЧ_Товары.Партия = ОстаткиНоменклатурыОстатки.Партия";
	
	Запрос.УстановитьПараметр("Период", Дата);
	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		//Проверяем , что Товара вообще хватает 
		Если ВыборкаДетальныеЗаписи.Количество > ВыборкаДетальныеЗаписи.КоличествоОстаток Тогда 
			
			Отказ = Истина;
			
			Сообщение = Новый СообщениеПользователю;
			Сообщение.Текст = СтрШаблон("Недостаточно Товара %1 по партии %2 в количестве %3", 
			ВыборкаДетальныеЗаписи.НоменклатураПредставление,
			ВыборкаДетальныеЗаписи.ПартияПредставление,
			(ВыборкаДетальныеЗаписи.ВыборкаДетальныеЗаписи.Количество 
			- ВыборкаДетальныеЗаписи.КоличествоОстаток));
			Сообщение.УстановитьДанные();
			Сообщение.Сообщить();
		КонецЕсли;
		
		Если Отказ Тогда 
			Продолжить;
		КонецЕсли;
		
		//Проверяем списание под  остаток
		
		Если ВыборкаДетальныеЗаписи.Количество = ВыборкаДетальныеЗаписи.КоличествоОстаток	Тогда 
			//Списываем под ноль
			Себестоимость =  ВыборкаДетальныеЗаписи.СтоимостьОстаток;
		Иначе 
			//Считаем Себестоимость(Белоусов)
			//ЦенаСписания = Остаток по сумме / Остаток по количеству 
			//Себестоимость = Сумма списания = ЦенаСписания * Списываемое количество	

			ЦенаСписания = ВыборкаДетальныеЗаписи.СтоимостьОстаток / ВыборкаДетальныеЗаписи.КоличествоОстаток; 
			Себестоимость = ЦенаСписания * ВыборкаДетальныеЗаписи.Количество;
			
		КонецЕсли;
		
		
		
		//Форимруем расходные Движения по РН
		
		Движение = Движения.ОстаткиНоменклатуры.ДобавитьРасход();
		
		//Приемник /Источник заполняем совпадающие		
		ЗаполнитьЗначенияСвойств(Движение, ВыборкаДетальныеЗаписи);
		Движение.Стоимость = Себестоимость ;
		
		
		
		
	КонецЦикла;
	
